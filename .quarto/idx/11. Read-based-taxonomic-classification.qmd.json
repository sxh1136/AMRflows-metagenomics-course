{"title":"11. Taxonomic Classification with MetaPhlAn","markdown":{"headingText":"11. Taxonomic Classification with MetaPhlAn","containsRefs":false,"markdown":"In this section, we will dive into the practical aspects of read-based taxonomic classification using MetaPhlAn, a popular tool for profiling the taxonomic composition of metagenomic samples. MetaPhlAn stands for \"Metagenomic Phylogenetic Analysis\" and is widely used for its accuracy and efficiency in characterizing microbial communities from shotgun metagenomic sequencing data.\n\n### What is MetaPhlAn\nMetaPhlAn is a tool developed by the Segata Lab for taxonomic profiling of metagenomic samples. It uses unique clade-specific marker genes to identify and quantify the presence of microbes in a given metagenomic dataset. The output of running MetaPhlAn is a relative abundance table which can be visualised in various ways. You can (should) read more about it on it's github page: https://github.com/biobakery/MetaPhlAn.\n\n#### Installing MetaPhlAn\nWe can use conda to install the latest version of MetaPhlAn as we learnt before. Detailled instructions on installing the tool can be found at https://github.com/biobakery/MetaPhlAn/wiki/MetaPhlAn-4#installation.\n\n```bash\nconda create --name metaphlan python=3.7\nconda activate metaphlan\nconda install -c bioconda metaphlan\n```\n\nWe will also need to download MetaPhlAn's required databases. This can be done with:\n\n```bash\nmetaphlan --install --bowtie2db <database folder>\n```\n\nReplace <database folder> with the path to where you want to download the database. You need a minimum of 15 GB of space.\n\n### Running MetaPhlAn\nTo perform taxonomic classification with MetaPhlAn, you'll need to provide it with metagenomic sequencing data in FASTQ format. \n\nFor single-end reads:\n```bash\nmetaphlan input.fastq --input_type fastq --bowtie2out metagenome.bowtie2.bz2 --nproc 8 -o profiled_metagenome.txt \n```\n\nFor paired-end reads:\n```bash\nmetaphlan input_1.fastq,input_2.fastq --bowtie2out metagenome.bowtie2.bz2 --nproc 8 --input_type fastq -o profiled_metagenome.txt\n```\n\n* The flag `--bowtie2out` saves the intermediate alignment files into metagenome.bowtie2.bz2. This allows us to rerun metaphlan extremley quickly. \n* The flag `--nproc` specifies how many CPUs we allocate to metaphlan. Generally, more CPUs the faster it will run but this depends on your computer's specifications. \n* Metaphlan can also estimate the unknown fraction of the metagenome using the percentage of reads mapping to their database to scale the relative abundance profiles. This can be enabled with the `--unclassified_estimation` flag.\n\nThe output of metaphlan is two column tab seperated text file. The first column contains the different microbial clades that have been predicted whilst the second column contains the corresponding relative abundances (%). If we look inside `profiled_metagenome.txt` this is what we would see:\n\n```\n# Database version\n# Metaphlan command executed\n# Number of reads processed \n# SampleID Metaphlan_Analysis\n# clade_name NCBI_tax_id relative_abundance additional_species\nUNCLASSIFIED 5.7891\nk__Bacteria 2  84.6758\nk__Bacteria|p__Actinobacteria 2|201174 45.8922\nk__Bacteria|p__Proteobacteria 2|1224 23.1078\nk__Bacteria|p__Actinobacteria|c__Actinobacteria 2|201174|1760 44.6724\nk__Bacteria|p__Proteobacteria|c__Betaproteobacteria 2|1224|28216 22.0178\n...\n```\n\nThe first five rows which begin with `#` are header rows which give more information about your metaphlan run. The last header row contains four headers for each of the columns below it:\n* **clade_name** - The taxonomy of the clade reported on this row. Each taxonomic level is indicated by a prefix: Kingdom - k__, Phylym - p__, Classs - c__, Order - o__, Family - f__, Genus - g__, s__ - species, species genome bin (SGB) - t__.\n* **NCBI_tax_id** - The corresponding NCBI taxon ID for the clade in **clade_name**.\n* **relative_abundnace** - The clade's relative abundance in %. Clades are hierarchally summed meaning each taxonomic level will equal 100%. Note that if unclassifed estimation is performed, each taxonomic level will add up to 100% minus unclassified percentage.\n* **additional_species** - In cases where a clade is represented by multiple species, alternative species names are listed in this column. **clade_name** still lists the representative species.\n\nLets use `grep` to find out more about our family of interest - Enterococcaceae. \n\n```bash \ngrep \"Enterococcaceae\" profiled_metagenome | head -1\n```\n\nNote: We use the pipe `|` symbol for the first time here. This command redirects the output of the command before it to the command after it allowing us to chain commands together. In the example above the grepped text is fed into the head command which returns us just the first line of the grep output.\n\nThis yields:\n```bash\nk__Bacteria|p__Firmicutes|c__Bacilli|o__Lactobacillales|f__Enterococcaceae      2|1239|91061|186826|81852       14.517849033370496\n```\nThis output shows that info about the family Enterococcaceae in our metagenome was successfully extracted, with it making up 14.5% of its composition.\n\n### Merging metaphlan profiles\nIn most studies we will be investigating the taxonomic profile of multiple metagenomic samples. Therefore it is useful to combine multiple metaphlan outputs into a matrix for comparison and visualisation. Fortunately, metaphlan includes an utility script for this exact purpose:\n\n```bash\nmerge_metaphlan_tables.py *.txt > merged_abundance_table.txt\n```\n\nThis merged table only retains sample names, clades names, and relative abundances. You can easily view this file as a spreadsheet using Excel or with `less`.\n\n```bash\n# -S is the less flag for chopping off the ends of lines when they are longer than the screen width instead of wrapping. I find that this often makings files like merged metaphlan files much easier to read.\nless -S merged_abundance_table.txt\n```\nThe first few lines would look like this:\n\n```bash\n#mpa_vJan21_CHOCOPhlAnSGB_202103\n\nclade_name Sample_1 Sample_2 Sample_3 Sample_4\n\nUNCLASSIFIED 10.2 9.43 2.98 4.44 \nk__Bacteria 88.2 90.4 80.04 87.99\nk__Bacteria|p__Bacteroidetes 75.78146 2.342 23.1323 10.41\nk__Bacteria|p__Firmicutes 11.84254 3.12346 43.1642 69.96495\nk__Bacteria|p__Bacteroidetes|c__Bacteroidia 73.78146 2.2123 20.09994 10.41\n```\n\n### Visualising taxonomic profiles. \nThe most common and widely applicable method for visualising taxonomic profiles such as those produced by metaphlan is with a heatmap.\n\nThe first step of making a heatmap is to decide what taxonomic level you want to visualise at. This will depend on the goal of your study and what you want to display in your figure. For this example we will use the species level. \n\nTo extract only species level clades from our merged table we use the following command:\n\n```bash\ngrep -E \"clade|s__\" merged_abundance_table.txt | grep -Ev \"t__\" | sed \"s/^.*s__//g\" > merged_abundance_table_species.txt\n```\n\nThis command first uses `grep` to extract the header line by matching \"clade\" and all rows with species assignments. The second grep removes lines which have been resolved to SGB level leaving us with only species level clades. The sed command removes everything before and including \"s__\" leaving us with only the species name in the **clade_name** column (You can read more about the `sed` command [here](https://www.howtogeek.com/666395/how-to-use-the-sed-command-on-linux/)). The `>` redirects the output of the chain of commands to the file `merged_abundance_table_species.txt` instead of just printing it out (You can read more about redirect outputs [here](https://www.redhat.com/sysadmin/redirect-shell-command-script-output)). \n\nThe first few lines of the new file looks like this:\n\n```bash\nclade_name Sample_1 Sample_2 Sample_3 Sample_4\n\nEnterococcus_faecium 22.09729 1.13 0.0 3.334 \nParabacteroides_distasonis 0.0 1.52429 11.4621 0.0 \nBacteroides_fragilis 16.21854 2.8948 0.0 0.0 \nMethanobrevibacter_smithii 0.0 0.0 19.34642 0.0 \n```\n\n### Visualising taxonomic profiles with a heatmap\nThis data is now ready for visualisation. There are many different ways to produce a heatmap, especially if you have experience with data focused programming languages like python or R. Most methods are very comparable and only differ in aesthetics. In this tutorial we'll be using [hclust2](https://github.com/SegataLab/hclust2) which can be installed via Conda.\n\n*I've been informed that hclust2 might not play nicely with ARM based hardware such as Apple's M series Macs. If you do encounter issues with this and have some experience with R programming, a good alternative tool is pheatmap. A good guide on hierarchical clustering and creating heatmaps with pheatmap is linked [here](https://www.geeksforgeeks.org/creating-heatmaps-with-hierarchical-clustering/). If you're just following the code, you can start at the \"Removing Non-Numeric Labels\" section, as our metaphlan output is already in matrix form.\n\n```bash\nconda install -c biobakery hclust2\n```\n\nCheck if the tool has been installed correctly and have a look at the available flags with `hclust2 --help`.\n\nTo invoke the hclust2 python script and create a heatmap based on the species level table we generated earlier we can run the folliwng command:\n```bash\nhclust2.py \\\n-i merged_abundance_table_species.txt \\\n-o metaphlan_heatmap_species.png \\\n--f_dist_f braycurtis \\\n--s_dist_f braycurtis \\\n--minv 0.1 \\\n--ftop 50 \\\n--cell_aspect_ratio 1 \\\n--flabel_size 10 |\n--slabel_size 10 \\\n--max_flabel_len 100 |\n--max_slabel_len 100 \\\n--dpi 300\n```\nThis script takes our table as input with the `-i` flag and outputs a heatmap png file as detailed with the `-o` flag. For our distance functions we have selected Bray-Curtis dissimilarity for both our features (`--f_dist_f`), which in this case are our species and our samples (`--s_dist_f`). Bray-Curtis is a commonly used index which is used to assess how similar two samples are. It is particularly useful because it can handle the presence of zeros i.e. samples containing a relative abundance of 0 for certain species. A Bray-Curtis dissimilarity of 0 indicates that two samples have exactly the same composition, and a value of 1 indicates that their composition does not overlap at all. We then use the flags `--minv` and `--ftop` to set the minimum abundance value to be display and to only show the top 50 species in the heatmap. The rest of the flags affect the aestehtics of the heatmap. Can you work out what they affect?\n\nHere's an example of a heatmap created this way from a real published paper:\n\n![Heat map and hierarchical clustering of the top 40 taxa mapped by MetaPhlAn2 from [Highlander et al. 2023](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0282428)](images/heatmap.png){width=80%}\n\nCan you identify what the most abundant taxa in this heatmap is?\n\nCan you identify any clustering of samples?\n\nDo you notice any differences between the data used to create the heatmap here and the data we prepared ourselves?","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"markdown"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"11. Read-based-taxonomic-classification.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.361","theme":{"light":"cosmo"},"code-copy":true,"code-block-border-left":true,"code-block-bg":true},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}